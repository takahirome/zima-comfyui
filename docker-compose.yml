services:
  dify-api:
    container_name: dify-api
    image: langgenius/dify-api:1.4.2
    deploy:
      resources:
        reservations:
          memory: "1073741824"
        limits:
          memory: 8192M
    environment:
      - MODE=api
      - LOG_LEVEL=INFO
      - SECRET_KEY=sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U
      - DB_USERNAME=postgres
      - DB_PASSWORD=difyai123456
      - DB_HOST=dify-db
      - DB_PORT=5432
      - DB_DATABASE=dify
      - REDIS_HOST=dify-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=difyai123456
      - REDIS_DB=0
      - CELERY_BROKER_URL=redis://:difyai123456@dify-redis:6379/1
      - VECTOR_STORE=weaviate
      - WEAVIATE_ENDPOINT=http://dify-weaviate:8080
      - WEAVIATE_API_KEY=WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih
      - CODE_EXECUTION_ENDPOINT=http://dify-sandbox:8194
      - CODE_EXECUTION_API_KEY=dify-sandbox
      - PLUGIN_ENABLED=true
      - PLUGIN_DAEMON_ENDPOINT=http://dify-plugin-daemon:5003
      - PLUGIN_DAEMON_API_KEY=lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi
      - PLUGIN_REMOTE_INSTALL_HOST=dify-plugin-daemon
      - PLUGIN_REMOTE_INSTALL_PORT=5003
      - PLUGIN_MAX_PACKAGE_SIZE=52428800
      - INNER_API_KEY_FOR_PLUGIN=QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1
      - MIGRATION_ENABLED=true
      - WEB_API_CORS_ALLOW_ORIGINS=*
      - CONSOLE_CORS_ALLOW_ORIGINS=*
      - STORAGE_TYPE=local
      - STORAGE_LOCAL_PATH=storage
    volumes:
      - ./dify-data/storage:/app/api/storage
    depends_on:
      dify-db:
        condition: service_healthy
      dify-redis:
        condition: service_started
      dify-weaviate:
        condition: service_started
    restart: unless-stopped

  dify-worker:
    container_name: dify-worker
    image: langgenius/dify-api:1.4.2
    deploy:
      resources:
        reservations:
          memory: "1073741824"
        limits:
          memory: 4096M
    environment:
      - MODE=worker
      - LOG_LEVEL=INFO
      - SECRET_KEY=sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U
      - DB_USERNAME=postgres
      - DB_PASSWORD=difyai123456
      - DB_HOST=dify-db
      - DB_PORT=5432
      - DB_DATABASE=dify
      - REDIS_HOST=dify-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=difyai123456
      - REDIS_DB=0
      - CELERY_BROKER_URL=redis://:difyai123456@dify-redis:6379/1
      - VECTOR_STORE=weaviate
      - WEAVIATE_ENDPOINT=http://dify-weaviate:8080
      - WEAVIATE_API_KEY=WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih
      - PLUGIN_ENABLED=true
      - PLUGIN_DAEMON_ENDPOINT=http://dify-plugin-daemon:5003
      - PLUGIN_DAEMON_API_KEY=lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi
      - PLUGIN_REMOTE_INSTALL_HOST=dify-plugin-daemon
      - PLUGIN_REMOTE_INSTALL_PORT=5003
      - PLUGIN_MAX_PACKAGE_SIZE=52428800
      - INNER_API_KEY_FOR_PLUGIN=QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1
      - STORAGE_TYPE=local
      - STORAGE_LOCAL_PATH=storage
    volumes:
      - ./dify-data/storage:/app/api/storage
    depends_on:
      dify-db:
        condition: service_healthy
      dify-redis:
        condition: service_started
      dify-weaviate:
        condition: service_started
    restart: unless-stopped

  dify-web:
    container_name: dify-web
    image: langgenius/dify-web:1.4.2
    deploy:
      resources:
        reservations:
          memory: "536870912"
        limits:
          memory: 2048M
    environment:
      - CONSOLE_API_URL=
      - APP_API_URL=
    restart: unless-stopped

  dify-db:
    container_name: dify-db
    image: postgres:15-alpine
    deploy:
      resources:
        reservations:
          memory: "536870912"
        limits:
          memory: 2048M
    environment:
      - PGUSER=postgres
      - POSTGRES_PASSWORD=difyai123456
      - POSTGRES_DB=dify
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ./dify-data/db:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD", "pg_isready", "-h", "localhost", "-U", "postgres", "-d", "dify"]
      interval: 1s
      timeout: 3s
      retries: 60

  dify-redis:
    container_name: dify-redis
    image: redis:6-alpine
    deploy:
      resources:
        reservations:
          memory: "268435456"
        limits:
          memory: 1024M
    volumes:
      - ./dify-data/redis:/data
    command: redis-server --requirepass difyai123456
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

  dify-weaviate:
    container_name: dify-weaviate
    image: semitechnologies/weaviate:1.19.0
    deploy:
      resources:
        reservations:
          memory: "536870912"
        limits:
          memory: 2048M
    environment:
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=false
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=none
      - CLUSTER_HOSTNAME=node1
      - AUTHENTICATION_APIKEY_ENABLED=true
      - AUTHENTICATION_APIKEY_ALLOWED_KEYS=WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih
      - AUTHENTICATION_APIKEY_USERS=hello@dify.ai
      - AUTHORIZATION_ADMINLIST_ENABLED=true
      - AUTHORIZATION_ADMINLIST_USERS=hello@dify.ai
    volumes:
      - ./dify-data/weaviate:/var/lib/weaviate
    restart: unless-stopped

  dify-sandbox:
    container_name: dify-sandbox
    image: langgenius/dify-sandbox:0.2.1
    deploy:
      resources:
        reservations:
          memory: "268435456"
        limits:
          memory: 1024M
    environment:
      - API_KEY=dify-sandbox
      - GIN_MODE=release
      - WORKER_TIMEOUT=15
      - ENABLE_NETWORK=true
      - SANDBOX_PORT=8194
    volumes:
      - ./dify-data/sandbox:/dependencies
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8194/health"]

  dify-plugin-daemon:
    container_name: dify-plugin-daemon
    image: langgenius/dify-plugin-daemon:0.1.2-local
    ports:
      - "5003:5003"
    deploy:
      resources:
        reservations:
          memory: "268435456"
        limits:
          memory: 1024M
    environment:
      - SERVER_PORT=5002
      - SERVER_KEY=lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi
      - GIN_MODE=release
      - PLATFORM=local
      - DIFY_INNER_API_KEY=QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1
      - DIFY_INNER_API_URL=http://dify-api:5001
      - PLUGIN_REMOTE_INSTALLING_ENABLED=true
      - PLUGIN_REMOTE_INSTALLING_HOST=0.0.0.0
      - PLUGIN_REMOTE_INSTALLING_PORT=5003
      - PLUGIN_STORAGE_TYPE=local
      - PLUGIN_STORAGE_LOCAL_ROOT=/app/storage
      - PLUGIN_INSTALLED_PATH=plugin
      - PLUGIN_WORKING_PATH=cwd
      - PERSISTENCE_STORAGE_PATH=persistence
      - PERSISTENCE_STORAGE_MAX_SIZE=104857600
      - PLUGIN_WEBHOOK_ENABLED=true
      - ROUTINE_POOL_SIZE=1024
      - REDIS_HOST=dify-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=difyai123456
      - REDIS_DB=0
      - REDIS_USE_SENTINEL=false
      - DB_USERNAME=postgres
      - DB_PASSWORD=difyai123456
      - DB_HOST=dify-db
      - DB_PORT=5432
      - DB_DATABASE=dify_plugin
      - DB_SSL_MODE=disable
      - DB_MAX_IDLE_CONNS=10
      - DB_MAX_OPEN_CONNS=30
      - DB_CONN_MAX_LIFETIME=3600
      - DIFY_INVOCATION_CONNECTION_IDLE_TIMEOUT=120
      - MAX_PLUGIN_PACKAGE_SIZE=52428800
      - PYTHON_ENV_INIT_TIMEOUT=120
      - PPROF_ENABLED=false
      - FORCE_VERIFYING_SIGNATURE=false
      - THIRD_PARTY_SIGNATURE_VERIFICATION_ENABLED=false
      - MARKETPLACE_ENABLED=true
      - MARKETPLACE_API_URL=https://marketplace.dify.ai
      - PLUGIN_STDIO_BUFFER_SIZE=1024
      - PLUGIN_STDIO_MAX_BUFFER_SIZE=5242880
      - DIFY_BACKWARDS_INVOCATION_WRITE_TIMEOUT=5000
      - DIFY_BACKWARDS_INVOCATION_READ_TIMEOUT=240000
    volumes:
      - ./dify-data/plugin-daemon:/app/storage
    depends_on:
      dify-db:
        condition: service_healthy
    restart: unless-stopped

  dify-nginx:
    container_name: dify-nginx
    image: nginx:latest
    ports:
      - "3701:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/proxy.conf:/etc/nginx/conf.d/proxy.conf
    depends_on:
      - dify-api
      - dify-web
    restart: unless-stopped

volumes:
  dify-data:
